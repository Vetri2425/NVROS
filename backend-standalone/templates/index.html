<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Rover Backend Monitor</title>
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  <style>
    body {
      font-family: monospace;
      background-color: #0d1117;
      color: #00ff88;
      margin: 0;
      padding: 20px;
    }
    h1 { color: #4ade80; }
    .log-box {
      background: #000;
      border: 1px solid #444;
      border-radius: 8px;
      padding: 10px;
      height: 400px;
      overflow-y: scroll;
      margin-top: 10px;
    }
    .status-bar {
      display: flex;
      gap: 20px;
      margin-bottom: 10px;
      font-weight: bold;
    }
    .status-item {
      padding: 4px 8px;
      border-radius: 6px;
    }
    .status-ok { background-color: #166534; color: #22c55e; }
    .status-warn { background-color: #78350f; color: #fbbf24; }
    .status-error { background-color: #7f1d1d; color: #f87171; }
    button {
      background-color: #4ade80;
      color: black;
      font-weight: bold;
      border: none;
      border-radius: 5px;
      padding: 8px 16px;
      cursor: pointer;
      margin-right: 10px;
    }
    button:hover {
      background-color: #22c55e;
    }
  </style>
</head>
<body>
  <h1>üõ∞Ô∏è Rover Backend Monitor</h1>

  <div class="status-bar">
    <div id="pixhawkStatus" class="status-item status-warn">Pixhawk: Waiting...</div>
    <div id="rtkStatus" class="status-item status-warn">RTK: Stopped</div>
  </div>

  <div>
    <button onclick="startRTK()">Start RTK</button>
    <button onclick="stopRTK()">Stop RTK</button>
  </div>

  <div id="logBox" class="log-box"></div>

  <script>
    const socket = io();
    const logBox = document.getElementById('logBox');
    const pixhawkStatus = document.getElementById('pixhawkStatus');
    const rtkStatus = document.getElementById('rtkStatus');

    function appendLog(msg, type = "INFO") {
      const line = document.createElement('div');
      let color;
      if (type.includes('ERROR')) color = '#f87171';
      else if (type.includes('WARN')) color = '#fbbf24';
      else color = '#22c55e';
      line.style.color = color;
      line.textContent = '> [' + type + '] ' + msg;
      logBox.appendChild(line);
      logBox.scrollTop = logBox.scrollHeight;
    }

    // --- Connection Events ---
    socket.on('connect', () => appendLog('Connected to backend.'));
    socket.on('disconnect', () => appendLog('Disconnected from backend.', 'WARN'));

    // --- Pixhawk Link Status ---
    socket.on('connection_status', (data) => {
      const status = data.status || "UNKNOWN";
      appendLog('Vehicle connection: ' + status);
      if (status === 'CONNECTED_TO_ROVER') {
        pixhawkStatus.textContent = 'Pixhawk: Connected ‚úÖ';
        pixhawkStatus.className = 'status-item status-ok';
      } else if (status === 'WAITING_FOR_ROVER') {
        pixhawkStatus.textContent = 'Pixhawk: Waiting...';
        pixhawkStatus.className = 'status-item status-warn';
      } else {
        pixhawkStatus.textContent = 'Pixhawk: Error';
        pixhawkStatus.className = 'status-item status-error';
      }
    });

    // --- RTK Events ---
    socket.on('rtk_log', (data) => appendLog(data.message));
    socket.on('rtk_status', (data) => {
      appendLog('RTK Status: ' + data.status);
      if (data.status === 'connected') {
        rtkStatus.textContent = 'RTK: Connected ‚úÖ';
        rtkStatus.className = 'status-item status-ok';
      } else if (data.status === 'stopped') {
        rtkStatus.textContent = 'RTK: Stopped';
        rtkStatus.className = 'status-item status-warn';
      } else {
        rtkStatus.textContent = 'RTK: Error';
        rtkStatus.className = 'status-item status-error';
      }
    });

    // --- Start/Stop Buttons ---
    function startRTK() {
      appendLog('Start RTK requested', 'ACTION');
      socket.emit('start_rtk', {
        host: "caster.emlid.com",
        port: "2101",
        mountpoint: "MP23960",
        username: "u98264",
        password: "998ckc"
      });
    }

    function stopRTK() {
      appendLog('Stop RTK requested', 'ACTION');
      socket.emit('stop_rtk');
    }
  </script>
</body>
</html>
