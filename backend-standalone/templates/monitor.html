<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>NRP Backend Activity Monitor</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body {
    font-family: Arial, Helvetica, sans-serif;
    margin: 0;
    background-color: #0f172a;
    color: #e2e8f0;
}
header {
    background: #111827;
    padding: 1rem 1.5rem;
    font-size: 1.4rem;
    font-weight: bold;
    border-bottom: 1px solid #1f2937;
}
.page {
    padding: 1.5rem;
    display: flex;
    flex-direction: column;
    gap: 1rem;
}
.toolbar {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    align-items: center;
    background: #111827;
    padding: 1rem;
    border: 1px solid #1f2937;
    border-radius: 0.5rem;
}
.toolbar label {
    display: flex;
    flex-direction: column;
    font-size: 0.85rem;
    color: #94a3b8;
    gap: 0.3rem;
}
.toolbar select,
.toolbar input {
    background: #0f172a;
    border: 1px solid #1f2937;
    color: #e2e8f0;
    padding: 0.4rem 0.6rem;
    border-radius: 0.35rem;
}
.toolbar button {
    background: #2563eb;
    color: #e2e8f0;
    border: none;
    border-radius: 0.35rem;
    padding: 0.45rem 0.8rem;
    cursor: pointer;
    font-weight: 600;
}
.toolbar button:hover {
    background: #1d4ed8;
}
.tabs {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1rem;
}
.tab-button {
    background: #374151;
    color: #e2e8f0;
    border: 1px solid #4b5563;
    border-radius: 0.35rem;
    padding: 0.5rem 1rem;
    cursor: pointer;
    font-weight: 600;
}
.tab-button:hover {
    background: #4b5563;
}
.tab-button.active {
    background: #2563eb;
    border-color: #2563eb;
}
.tab-content {
    display: none;
}
.tab-content.active {
    display: block;
}
.status-strip {
    display: flex;
    gap: 1.5rem;
    flex-wrap: wrap;
    font-size: 0.9rem;
    color: #94a3b8;
}
.status-strip span {
    display: flex;
    align-items: center;
    gap: 0.35rem;
}
.status-pill {
    padding: 0.15rem 0.5rem;
    border-radius: 999px;
    font-size: 0.8rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}
.status-pill.ok {
    background: #047857;
    color: #d1fae5;
}
.status-pill.warn {
    background: #b91c1c;
    color: #fee2e2;
}
.log-container {
    background: #111827;
    border: 1px solid #1f2937;
    border-radius: 0.5rem;
    overflow: hidden;
    display: flex;
    flex-direction: column;
}
.log-scroll {
    overflow-y: auto;
    max-height: 65vh;
}
table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.85rem;
}
thead {
    background: #1f2937;
    position: sticky;
    top: 0;
    z-index: 1;
}
th, td {
    padding: 0.55rem 0.75rem;
    border-bottom: 1px solid #1f2937;
    text-align: left;
    vertical-align: top;
}
tbody tr:nth-child(even) {
    background: rgba(15, 23, 42, 0.6);
}
tr.level-error {
    background: rgba(220, 38, 38, 0.15);
}
tr.level-warning {
    background: rgba(234, 179, 8, 0.18);
}
code {
    font-family: Consolas, Menlo, Monaco, monospace;
    font-size: 0.8rem;
}
.message {
    white-space: pre-wrap;
}
@media (max-width: 720px) {
    header {
        font-size: 1.1rem;
    }
    th, td {
        font-size: 0.75rem;
    }
    .toolbar {
        flex-direction: column;
        align-items: flex-start;
    }
    .toolbar label {
        width: 100%;
    }
    .status-strip {
        flex-direction: column;
    }
}
</style>
</head>
<body>
<header>NRP Backend Activity Monitor</header>
<div class="page">
    <div class="tabs">
        <button class="tab-button active" data-tab="activity">Activity</button>
        <button class="tab-button" data-tab="nodes">Node Status</button>
    </div>
    <div id="activity-tab" class="tab-content active">
        <div class="toolbar">
            <label>
                Event type
                <select id="event-filter">
                    <option value="">All events</option>
                </select>
            </label>
            <label>
                Text filter
                <input type="text" id="text-filter" placeholder="Search message or meta">
            </label>
            <label>
                <span>Display options</span>
                <span>
                    <input type="checkbox" id="auto-scroll" checked> Auto-scroll
                </span>
            </label>
            <button id="refresh-button" type="button">Refresh</button>
            <button id="download-button" type="button">Download</button>
        </div>
        <div class="status-strip">
            <span>Socket:
                <span id="socket-status" class="status-pill warn">Connecting</span>
            </span>
            <span>Showing <span id="result-count">0</span> entries</span>
            <span>Last update <span id="last-updated">-</span></span>
        </div>
        <div class="log-container">
            <div class="log-scroll" id="log-scroll">
                <table id="activity-table">
                    <thead>
                        <tr>
                            <th>Time (UTC)</th>
                            <th>Level</th>
                            <th>Event</th>
                            <th>Message</th>
                            <th>Meta</th>
                        </tr>
                    </thead>
                    <tbody id="activity-body"></tbody>
                </table>
            </div>
        </div>
    </div>
    <div id="nodes-tab" class="tab-content">
        <div class="toolbar">
            <button id="refresh-nodes-button" type="button">Refresh Nodes</button>
        </div>
        <div class="status-strip">
            <span>ROS Nodes: <span id="node-count">0</span></span>
            <span>Last update <span id="nodes-last-updated">-</span></span>
        </div>
        <div class="log-container">
            <div class="log-scroll" id="nodes-scroll">
                <table id="nodes-table">
                    <thead>
                        <tr>
                            <th>Node Name</th>
                        </tr>
                    </thead>
                    <tbody id="nodes-body"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>
<script src="https://cdn.socket.io/4.7.5/socket.io.min.js" crossorigin="anonymous"></script>
<script>
(function () {
    const API_LIMIT = 1000;
    const entries = [];
    const tableBody = document.getElementById('activity-body');
    const filterSelect = document.getElementById('event-filter');
    const searchInput = document.getElementById('text-filter');
    const autoScroll = document.getElementById('auto-scroll');
    const statusEl = document.getElementById('socket-status');
    const countEl = document.getElementById('result-count');
    const lastUpdatedEl = document.getElementById('last-updated');
    const logScroll = document.getElementById('log-scroll');
    const refreshButton = document.getElementById('refresh-button');
    const downloadButton = document.getElementById('download-button');
    const knownEvents = new Set();
    let renderQueued = false;

    // Tab switching
    const tabButtons = document.querySelectorAll('.tab-button');
    const tabContents = document.querySelectorAll('.tab-content');
    tabButtons.forEach(button => {
        button.addEventListener('click', () => {
            tabButtons.forEach(btn => btn.classList.remove('active'));
            tabContents.forEach(content => content.classList.remove('active'));
            button.classList.add('active');
            const tabId = button.getAttribute('data-tab') + '-tab';
            document.getElementById(tabId).classList.add('active');
        });
    });

    // Nodes functionality
    const nodesBody = document.getElementById('nodes-body');
    const nodeCountEl = document.getElementById('node-count');
    const nodesLastUpdatedEl = document.getElementById('nodes-last-updated');
    const refreshNodesButton = document.getElementById('refresh-nodes-button');

    async function loadNodes() {
        try {
            const response = await fetch('/api/nodes');
            const data = await response.json();
            nodesBody.innerHTML = '';
            if (Array.isArray(data.nodes)) {
                data.nodes.forEach(node => {
                    const tr = document.createElement('tr');
                    const td = document.createElement('td');
                    const link = document.createElement('a');
                    link.href = `/node/${encodeURIComponent(node)}`;
                    link.textContent = node;
                    link.style.color = '#60a5fa';
                    link.style.textDecoration = 'none';
                    link.addEventListener('mouseover', () => link.style.textDecoration = 'underline');
                    link.addEventListener('mouseout', () => link.style.textDecoration = 'none');
                    td.appendChild(link);
                    tr.appendChild(td);
                    nodesBody.appendChild(tr);
                });
                nodeCountEl.textContent = data.count;
            } else {
                nodeCountEl.textContent = 'Error';
            }
            nodesLastUpdatedEl.textContent = new Date().toISOString();
        } catch (err) {
            console.error('Failed to fetch nodes', err);
            nodeCountEl.textContent = 'Error';
        }
    }

    refreshNodesButton.addEventListener('click', loadNodes);

    function classForLevel(level) {
        if (!level) {
            return '';
        }
        const lower = String(level).toLowerCase();
        if (lower === 'error') {
            return 'level-error';
        }
        if (lower === 'warning' || lower === 'warn') {
            return 'level-warning';
        }
        return '';
    }

    function formatMeta(meta) {
        if (meta === null || meta === undefined) {
            return '';
        }
        if (typeof meta === 'string' || typeof meta === 'number' || typeof meta === 'boolean') {
            return String(meta);
        }
        try {
            return JSON.stringify(meta);
        } catch (err) {
            return String(meta);
        }
    }

    function matchesFilter(entry) {
        const selected = filterSelect.value;
        if (selected && entry.event !== selected) {
            return false;
        }
        const search = searchInput.value.trim().toLowerCase();
        if (!search) {
            return true;
        }
        const text = [
            entry.message || '',
            entry.level || '',
            entry.event || '',
            formatMeta(entry.meta)
        ].join(' ').toLowerCase();
        return text.indexOf(search) !== -1;
    }

    function updateFilterOptions() {
        let changed = false;
        entries.forEach((entry) => {
            if (entry.event && !knownEvents.has(entry.event)) {
                knownEvents.add(entry.event);
                changed = true;
            }
        });
        if (!changed) {
            return;
        }
        const current = filterSelect.value;
        const options = [''];
        knownEvents.forEach((event) => options.push(event));
        options.sort((a, b) => a.localeCompare(b));
        filterSelect.innerHTML = '';
        options.forEach((value) => {
            const option = document.createElement('option');
            option.value = value;
            option.textContent = value ? value : 'All events';
            filterSelect.appendChild(option);
        });
        filterSelect.value = current;
    }

    function render() {
        const filtered = entries.filter(matchesFilter);
        tableBody.innerHTML = '';
        filtered.forEach((entry) => {
            const tr = document.createElement('tr');
            tr.className = classForLevel(entry.level);

            const tsCell = document.createElement('td');
            tsCell.textContent = entry.isoTime || '';
            tr.appendChild(tsCell);

            const levelCell = document.createElement('td');
            levelCell.textContent = entry.level || '';
            tr.appendChild(levelCell);

            const eventCell = document.createElement('td');
            eventCell.textContent = entry.event || '';
            tr.appendChild(eventCell);

            const messageCell = document.createElement('td');
            messageCell.className = 'message';
            messageCell.textContent = entry.message || '';
            tr.appendChild(messageCell);

            const metaCell = document.createElement('td');
            metaCell.innerHTML = '<code></code>';
            const code = metaCell.querySelector('code');
            code.textContent = formatMeta(entry.meta);
            tr.appendChild(metaCell);

            tableBody.appendChild(tr);
        });
        countEl.textContent = filtered.length;
        if (filtered.length > 0) {
            lastUpdatedEl.textContent = filtered[filtered.length - 1].isoTime || '-';
        }
        if (autoScroll.checked) {
            logScroll.scrollTop = logScroll.scrollHeight;
        }
    }

    function scheduleRender() {
        if (renderQueued) {
            return;
        }
        renderQueued = true;
        window.requestAnimationFrame(() => {
            renderQueued = false;
            render();
        });
    }

    async function loadInitial() {
        try {
            const response = await fetch('/api/activity?limit=' + API_LIMIT);
            const data = await response.json();
            entries.length = 0;
            if (Array.isArray(data.entries)) {
                data.entries.forEach((entry) => entries.push(entry));
            }
            updateFilterOptions();
            scheduleRender();
        } catch (err) {
            console.error('Failed to fetch activity', err);
        }
    }

    async function refreshTypes() {
        try {
            const response = await fetch('/api/activity/types');
            const data = await response.json();
            if (Array.isArray(data.events)) {
                data.events.forEach((event) => knownEvents.add(event));
                updateFilterOptions();
            }
        } catch (err) {
            console.error('Failed to fetch activity types', err);
        }
    }

    filterSelect.addEventListener('change', scheduleRender);
    searchInput.addEventListener('input', scheduleRender);
    autoScroll.addEventListener('change', scheduleRender);

    refreshButton.addEventListener('click', (event) => {
        event.preventDefault();
        loadInitial();
    });

    downloadButton.addEventListener('click', (event) => {
        event.preventDefault();
        window.open('/api/activity/download', '_blank');
    });

    const socket = io();
    socket.on('connect', () => {
        statusEl.textContent = 'Connected';
        statusEl.className = 'status-pill ok';
    });
    socket.on('disconnect', () => {
        statusEl.textContent = 'Disconnected';
        statusEl.className = 'status-pill warn';
    });
    socket.on('server_activity', (entry) => {
        entries.push(entry);
        if (entries.length > API_LIMIT * 5) {
            entries.splice(0, entries.length - API_LIMIT * 5);
        }
        if (entry && entry.event) {
            knownEvents.add(entry.event);
            updateFilterOptions();
        }
        scheduleRender();
    });

    loadInitial();
    refreshTypes();
    loadNodes();
})();</script>
</body>
</html>
